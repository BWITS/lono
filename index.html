<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Lono : Lono generates cloud formation templates based on erb templates">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Lono</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/tongueroo/lono">View on GitHub</a>

          <h1 id="project_title">Lono</h1>
          <h2 id="project_tagline">Lono generates cloud formation templates based on erb templates</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/tongueroo/lono/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/tongueroo/lono/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a id="lono" class="anchor" href="#lono" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lono</h1>

<p>Lono is a Cloud Formation Template ruby generator.  Lono generates Cloud Formation templates based on ERB templates.</p>

<h2>
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h2>

<pre>
$ lono new lono
</pre>

<p>This sets up a starter lono project with example templates.</p>

<pre>
$ lono generate
</pre>

<p>This generates the templates that have been defined in the config folder of the lono project to the output folder.</p>

<p>The starter lono template project config files looks like <a href="lib/starter_project/config/lono.rb">this</a> and <a href="lib/starter_project/config/lono/api.rb">this</a>.  Here's a snippet from one of the config files with the template call:</p>

<div class="highlight highlight-ruby"><pre>template <span class="pl-s"><span class="pl-pds">"</span>prod-api-app.json<span class="pl-pds">"</span></span> <span class="pl-k">do</span>
  env,app,role <span class="pl-k">=</span> name.sub(<span class="pl-s"><span class="pl-pds">'</span>.json<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>).split(<span class="pl-s"><span class="pl-pds">'</span>-<span class="pl-pds">'</span></span>)
  source <span class="pl-s"><span class="pl-pds">"</span>app.json.erb<span class="pl-pds">"</span></span>
  variables(
    <span class="pl-c1">:env</span> =&gt; env,
    <span class="pl-c1">:app</span> =&gt; app,
    <span class="pl-c1">:role</span> =&gt; role,
    <span class="pl-c1">:ami</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>ami-123<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:instance_type</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>m1.small<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:port</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>80<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:high_threshold</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>15<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:high_periods</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>4<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:low_threshold</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>5<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:low_periods</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>10<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:max_size</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>24<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:min_size</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>6<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:down_adjustment</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>-3<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:up_adjustment</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>3<span class="pl-pds">"</span></span>,
    <span class="pl-c1">:ssl_cert</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>arn:aws:iam::12345:server-certificate/wildcard<span class="pl-pds">"</span></span>
  )
<span class="pl-k">end</span></pre></div>

<p>The corresponding ERB template example file is <a href="lib/starter_project/templates/app.json.erb">here</a>.</p>

<h2>
<a id="template-helper-methods" class="anchor" href="#template-helper-methods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Template helper methods</h2>

<p>There are helper methods that are available in templates.</p>

<ul>
<li>
<p>partial - can be use to embed other files in a template.  The partial should be placed in the templates/partial folder of the project.  So:</p>

<ul>
<li>partial('launch_config.json.erb') -&gt; templates/partial/launch_config.json.erb</li>
<li>partial('launch_config.json.erb', :foo =&gt; "bar", :hello =&gt; "world") - variables can be passed to the partial helper method and will be available to the partial as instance variables.  So, in this case <a href="https://github.com/foo" class="user-mention">@foo</a> and <a href="https://github.com/hello" class="user-mention">@hello</a> will be available in the launch_config.json.erb partial.</li>
</ul>
</li>
<li>
<p>user_data - can be used to include a user data script which is written in bash script form.  The user data script should be placed in the templates/user_data folder of the project.  So:</p>

<ul>
<li>user_data('bootstrap.sh.erb') -&gt; templates/user_data/bootstrap.sh.erb</li>
<li>user_data('db.sh.erb') -&gt; templates/user_data/db.sh.erb</li>
<li>user_data('script1.sh.erb', :foo =&gt; "bar", :hello =&gt; "world") - variables can be passed to the user_data helper method and will be available to the partial as instance variables.  So, in this case <a href="https://github.com/foo" class="user-mention">@foo</a> and <a href="https://github.com/hello" class="user-mention">@hello</a> will be available in script1.sh.erb.</li>
</ul>
</li>
</ul>

<p>Here's how you would call it in the template.</p>

<div class="highlight highlight-json"><pre><span class="pl-s"><span class="pl-pds">"</span>UserData<span class="pl-pds">"</span></span>: {
  <span class="pl-s"><span class="pl-pds">"</span>Fn::Base64<span class="pl-pds">"</span></span>: {
    <span class="pl-s"><span class="pl-pds">"</span>Fn::Join<span class="pl-pds">"</span></span>: [
      <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>,
      [
        <span class="pl-ii">&lt;%=</span> <span class="pl-ii">user_data('db.sh.erb')</span> <span class="pl-ii">%&gt;</span>
      ]
    ]
  }</pre></div>

<p>Within the user_data script you can use helper methods that correspond to Cloud Formation <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/concept-intrinsic-functions.html">Instrinic Functions</a>.  Currently, base64, find_in_map, get_att, get_azs, join, and ref are supported.  Here's a short example of a user_data script using a helper method:</p>

<p>If you have a templates/user_data/db.sh.erb that looks like this:</p>

<div class="highlight highlight-bash"><pre><span class="pl-c">#!/bin/bash -lexv</span>

HOSTNAME_PREFIX=<span class="pl-k">&lt;</span>%= find_in_map(<span class="pl-s"><span class="pl-pds">"</span>EnvironmentMapping<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>HostnamePrefix<span class="pl-pds">"</span></span>, ref(<span class="pl-s"><span class="pl-pds">"</span>Environment<span class="pl-pds">"</span></span>)) %<span class="pl-k">&gt;</span>

<span class="pl-c1">echo</span> <span class="pl-k">&lt;</span>%= ref(<span class="pl-s"><span class="pl-pds">"</span>AWS::StackName<span class="pl-pds">"</span></span>) %<span class="pl-k">&gt;</span> <span class="pl-k">&gt;</span> /tmp/stack_name
<span class="pl-c"># Helper function</span>
<span class="pl-k">function</span> <span class="pl-en">error_exit</span>
{
  /usr/local/bin/cfn-signal -e 1 -r <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$1</span><span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">'</span>&lt;%= ref("WaitHandle") %&gt;<span class="pl-pds">'</span></span>
<span class="pl-c1">exit</span> 1
}
<span class="pl-c"># Wait for the EBS volume to show up</span>
<span class="pl-k">while</span> [ <span class="pl-k">!</span> -e /dev/xvdf ]<span class="pl-k">;</span> <span class="pl-k">do</span> <span class="pl-c1">echo</span> Waiting <span class="pl-k">for</span> <span class="pl-smi">EBS</span> volume to attach<span class="pl-k">;</span> sleep 1<span class="pl-k">;</span> <span class="pl-k">done</span>
/bin/mkdir /media/redis
/sbin/mkfs -t ext4 /dev/xvdf
<span class="pl-c1">echo</span> <span class="pl-s"><span class="pl-pds">"</span>/dev/xvdf /media/redis auto defaults 0 0<span class="pl-pds">"</span></span> <span class="pl-k">&gt;&gt;</span> /etc/fstab
/bin/mount /media/redis
/usr/bin/redis-cli shutdown
sleep 10
mv /var/lib/redis/<span class="pl-k">*</span> /media/redis/
rm -r /var/lib/redis
ln -s /media/redis /var/lib/redis
chown -R redis:redis /var/lib/redis
chown -R redis:redis /media/redis
/usr/bin/redis-server
<span class="pl-c"># If all is well so signal success</span>
/usr/local/bin/cfn-signal -e <span class="pl-smi">$?</span> -r <span class="pl-s"><span class="pl-pds">"</span>Ready to rock<span class="pl-pds">"</span></span> <span class="pl-s"><span class="pl-pds">'</span>&lt;%= ref("WaitHandle") %&gt;<span class="pl-pds">'</span></span></pre></div>

<p>The user_data helper will transform the bash script into a json array of elements for Cloud Formation:</p>

<div class="highlight highlight-json"><pre>[
  <span class="pl-s"><span class="pl-pds">"</span>#!/bin/bash -lexv<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>HOSTNAME_PREFIX=<span class="pl-pds">"</span></span>,
  {
    <span class="pl-s"><span class="pl-pds">"</span>Fn::FindInMap<span class="pl-pds">"</span></span>: [
      <span class="pl-s"><span class="pl-pds">"</span>EnvironmentMapping<span class="pl-pds">"</span></span>,
      <span class="pl-s"><span class="pl-pds">"</span>HostnamePrefix<span class="pl-pds">"</span></span>,
      {
        <span class="pl-s"><span class="pl-pds">"</span>Ref<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Environment<span class="pl-pds">"</span></span>
      }
    ]
  },
  <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>echo <span class="pl-pds">"</span></span>,
  {
    <span class="pl-s"><span class="pl-pds">"</span>Ref<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>AWS::StackName<span class="pl-pds">"</span></span>
  },
  <span class="pl-s"><span class="pl-pds">"</span> &gt; /tmp/stack_name<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span># Helper function<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>function error_exit<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>{<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>  /usr/local/bin/cfn-signal -e 1 -r <span class="pl-cce">\"</span>$1<span class="pl-cce">\"</span> '<span class="pl-pds">"</span></span>,
  {
    <span class="pl-s"><span class="pl-pds">"</span>Ref<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>WaitHandle<span class="pl-pds">"</span></span>
  },
  <span class="pl-s"><span class="pl-pds">"</span>'<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>exit 1<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>}<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span># Wait for the EBS volume to show up<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>while [ ! -e /dev/xvdf ]; do echo Waiting for EBS volume to attach; sleep 1; done<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>/bin/mkdir /media/redis<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>/sbin/mkfs -t ext4 /dev/xvdf<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>echo <span class="pl-cce">\"</span>/dev/xvdf /media/redis auto defaults 0 0<span class="pl-cce">\"</span> &gt;&gt; /etc/fstab<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>/bin/mount /media/redis<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>/usr/bin/redis-cli shutdown<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>sleep 10<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>mv /var/lib/redis/* /media/redis/<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>rm -r /var/lib/redis<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>ln -s /media/redis /var/lib/redis<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>chown -R redis:redis /var/lib/redis<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>chown -R redis:redis /media/redis<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>/usr/bin/redis-server<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span># If all is well so signal success<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>,
  <span class="pl-s"><span class="pl-pds">"</span>/usr/local/bin/cfn-signal -e $? -r <span class="pl-cce">\"</span>Ready to rock<span class="pl-cce">\"</span> '<span class="pl-pds">"</span></span>,
  {
    <span class="pl-s"><span class="pl-pds">"</span>Ref<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>WaitHandle<span class="pl-pds">"</span></span>
  },
  <span class="pl-s"><span class="pl-pds">"</span>'<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>
]</pre></div>

<p>More examples of user_data and instrinic function helper method usage are found in the starter <a href="https://github.com/tongueroo/lono/blob/master/lib/starter_project/templates/user_data/db.sh.erb">project template</a></p>

<h2>
<a id="converting-userdata-scripts" class="anchor" href="#converting-userdata-scripts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Converting UserData scripts</h2>

<p>You can convert UserData scripts in existing Cloud Formation Templates to a starter bash script via:</p>

<pre>
$ lono bashify cloud_formation_template.json
$ lono bash cloud_formation_template.json # shorthand
$ lono b https://s3.amazonaws.com/cloudformation-templates-us-east-1/LAMP_Single_Instance.template # shorthand and url
</pre>

<p>This is useful if you want to take an existing <a href="http://aws.amazon.com/cloudformation/aws-cloudformation-templates/">Cloud Formation Template example</a> and quicklly change the UserData section into a bash script. The bashify command will generate a snippet that is meant to be copied and pasted into a bash script and used with user_data helper method.  The bash script should work right off the bat as lono will transform the generated Cloud Formation object references to json objects, there's no need to manually change what is generated to the helper methods, though you can if you prefer the look of the helper methods.</p>

<h2>
<a id="breaking-up-configlonorb" class="anchor" href="#breaking-up-configlonorb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Breaking up config/lono.rb</h2>

<p>If you have a lot of templates, the config/lono.rb file can get unwieldy long.  You can break up the lono.rb file and put template defintions in the config/lono directory.  Any file in this directory will be automatically loaded. An <a href="lib/starter_project/config/lono/api.rb">example</a> is in the starter project.</p>

<h2>
<a id="generate" class="anchor" href="#generate" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generate</h2>

<p>You can generate the CF templates by running:</p>

<pre>
$ lono generate
$ lono g -c # shortcut
</pre>

<p>The lono init command also sets up guard-lono.  Guard-lono continuously generates the cloud formation templates.  Just run guard.</p>

<pre>
$ guard
</pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Lono maintained by <a href="https://github.com/tongueroo">tongueroo</a></p>
        <p>Published with <a href="https://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
