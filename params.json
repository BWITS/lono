{"name":"Lono","tagline":"Lono generates cloud formation templates based on erb templates","body":"# Lono\r\n\r\nLono is a Cloud Formation Template ruby generator.  Lono generates Cloud Formation templates based on ERB templates.\r\n\r\n## Usage\r\n\r\n<pre>\r\n$ lono new lono\r\n</pre>\r\n\r\nThis sets up a starter lono project with example templates.\r\n\r\n<pre>\r\n$ lono generate\r\n</pre>\r\n\r\nThis generates the templates that have been defined in the config folder of the lono project to the output folder.\r\n\r\nThe starter lono template project config files looks like [this](lib/starter_project/config/lono.rb) and [this](lib/starter_project/config/lono/api.rb).  Here's a snippet from one of the config files with the template call:\r\n\r\n```ruby\r\ntemplate \"prod-api-app.json\" do\r\n  env,app,role = name.sub('.json','').split('-')\r\n  source \"app.json.erb\"\r\n  variables(\r\n    :env => env,\r\n    :app => app,\r\n    :role => role,\r\n    :ami => \"ami-123\",\r\n    :instance_type => \"m1.small\",\r\n    :port => \"80\",\r\n    :high_threshold => \"15\",\r\n    :high_periods => \"4\",\r\n    :low_threshold => \"5\",\r\n    :low_periods => \"10\",\r\n    :max_size => \"24\",\r\n    :min_size => \"6\",\r\n    :down_adjustment => \"-3\",\r\n    :up_adjustment => \"3\",\r\n    :ssl_cert => \"arn:aws:iam::12345:server-certificate/wildcard\"\r\n  )\r\nend\r\n```\r\n\r\nThe corresponding ERB template example file is [here](lib/starter_project/templates/app.json.erb).\r\n\r\n## Template helper methods\r\n\r\nThere are helper methods that are available in templates.\r\n\r\n* partial - can be use to embed other files in a template.  The partial should be placed in the templates/partial folder of the project.  So:\r\n  * partial('launch_config.json.erb') -> templates/partial/launch_config.json.erb\r\n  * partial('launch_config.json.erb', :foo => \"bar\", :hello => \"world\") - variables can be passed to the partial helper method and will be available to the partial as instance variables.  So, in this case @foo and @hello will be available in the launch_config.json.erb partial.\r\n\r\n* user_data - can be used to include a user data script which is written in bash script form.  The user data script should be placed in the templates/user_data folder of the project.  So:\r\n  * user_data('bootstrap.sh.erb') -> templates/user_data/bootstrap.sh.erb\r\n  * user_data('db.sh.erb') -> templates/user_data/db.sh.erb\r\n  * user_data('script1.sh.erb', :foo => \"bar\", :hello => \"world\") - variables can be passed to the user_data helper method and will be available to the partial as instance variables.  So, in this case @foo and @hello will be available in script1.sh.erb.\r\n\r\nHere's how you would call it in the template.\r\n\r\n```json\r\n\"UserData\": {\r\n  \"Fn::Base64\": {\r\n    \"Fn::Join\": [\r\n      \"\",\r\n      [\r\n        <%= user_data('db.sh.erb') %>\r\n      ]\r\n    ]\r\n  }\r\n```\r\n\r\nWithin the user_data script you can use helper methods that correspond to Cloud Formation [Instrinic Functions](http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/concept-intrinsic-functions.html).  Currently, base64, find_in_map, get_att, get_azs, join, and ref are supported.  Here's a short example of a user_data script using a helper method:\r\n\r\nIf you have a templates/user_data/db.sh.erb that looks like this:\r\n\r\n```bash\r\n#!/bin/bash -lexv\r\n\r\nHOSTNAME_PREFIX=<%= find_in_map(\"EnvironmentMapping\", \"HostnamePrefix\", ref(\"Environment\")) %>\r\n\r\necho <%= ref(\"AWS::StackName\") %> > /tmp/stack_name\r\n# Helper function\r\nfunction error_exit\r\n{\r\n  /usr/local/bin/cfn-signal -e 1 -r \"$1\" '<%= ref(\"WaitHandle\") %>'\r\nexit 1\r\n}\r\n# Wait for the EBS volume to show up\r\nwhile [ ! -e /dev/xvdf ]; do echo Waiting for EBS volume to attach; sleep 1; done\r\n/bin/mkdir /media/redis\r\n/sbin/mkfs -t ext4 /dev/xvdf\r\necho \"/dev/xvdf /media/redis auto defaults 0 0\" >> /etc/fstab\r\n/bin/mount /media/redis\r\n/usr/bin/redis-cli shutdown\r\nsleep 10\r\nmv /var/lib/redis/* /media/redis/\r\nrm -r /var/lib/redis\r\nln -s /media/redis /var/lib/redis\r\nchown -R redis:redis /var/lib/redis\r\nchown -R redis:redis /media/redis\r\n/usr/bin/redis-server\r\n# If all is well so signal success\r\n/usr/local/bin/cfn-signal -e $? -r \"Ready to rock\" '<%= ref(\"WaitHandle\") %>'\r\n```\r\n\r\nThe user_data helper will transform the bash script into a json array of elements for Cloud Formation:\r\n\r\n```json\r\n[\r\n  \"#!/bin/bash -lexv\\n\",\r\n  \"\\n\",\r\n  \"HOSTNAME_PREFIX=\",\r\n  {\r\n    \"Fn::FindInMap\": [\r\n      \"EnvironmentMapping\",\r\n      \"HostnamePrefix\",\r\n      {\r\n        \"Ref\": \"Environment\"\r\n      }\r\n    ]\r\n  },\r\n  \"\\n\",\r\n  \"\\n\",\r\n  \"echo \",\r\n  {\r\n    \"Ref\": \"AWS::StackName\"\r\n  },\r\n  \" > /tmp/stack_name\\n\",\r\n  \"# Helper function\\n\",\r\n  \"function error_exit\\n\",\r\n  \"{\\n\",\r\n  \"  /usr/local/bin/cfn-signal -e 1 -r \\\"$1\\\" '\",\r\n  {\r\n    \"Ref\": \"WaitHandle\"\r\n  },\r\n  \"'\\n\",\r\n  \"exit 1\\n\",\r\n  \"}\\n\",\r\n  \"# Wait for the EBS volume to show up\\n\",\r\n  \"while [ ! -e /dev/xvdf ]; do echo Waiting for EBS volume to attach; sleep 1; done\\n\",\r\n  \"/bin/mkdir /media/redis\\n\",\r\n  \"/sbin/mkfs -t ext4 /dev/xvdf\\n\",\r\n  \"echo \\\"/dev/xvdf /media/redis auto defaults 0 0\\\" >> /etc/fstab\\n\",\r\n  \"/bin/mount /media/redis\\n\",\r\n  \"/usr/bin/redis-cli shutdown\\n\",\r\n  \"sleep 10\\n\",\r\n  \"mv /var/lib/redis/* /media/redis/\\n\",\r\n  \"rm -r /var/lib/redis\\n\",\r\n  \"ln -s /media/redis /var/lib/redis\\n\",\r\n  \"chown -R redis:redis /var/lib/redis\\n\",\r\n  \"chown -R redis:redis /media/redis\\n\",\r\n  \"/usr/bin/redis-server\\n\",\r\n  \"# If all is well so signal success\\n\",\r\n  \"/usr/local/bin/cfn-signal -e $? -r \\\"Ready to rock\\\" '\",\r\n  {\r\n    \"Ref\": \"WaitHandle\"\r\n  },\r\n  \"'\\n\"\r\n]\r\n```\r\n\r\nMore examples of user_data and instrinic function helper method usage are found in the starter [project template](https://github.com/tongueroo/lono/blob/master/lib/starter_project/templates/user_data/db.sh.erb)\r\n\r\n## Converting UserData scripts\r\n\r\nYou can convert UserData scripts in existing Cloud Formation Templates to a starter bash script via:\r\n\r\n<pre>\r\n$ lono bashify cloud_formation_template.json\r\n$ lono bash cloud_formation_template.json # shorthand\r\n$ lono b https://s3.amazonaws.com/cloudformation-templates-us-east-1/LAMP_Single_Instance.template # shorthand and url\r\n</pre>\r\n\r\nThis is useful if you want to take an existing [Cloud Formation Template example](http://aws.amazon.com/cloudformation/aws-cloudformation-templates/) and quicklly change the UserData section into a bash script. The bashify command will generate a snippet that is meant to be copied and pasted into a bash script and used with user_data helper method.  The bash script should work right off the bat as lono will transform the generated Cloud Formation object references to json objects, there's no need to manually change what is generated to the helper methods, though you can if you prefer the look of the helper methods.\r\n\r\n## Breaking up config/lono.rb\r\n\r\nIf you have a lot of templates, the config/lono.rb file can get unwieldy long.  You can break up the lono.rb file and put template defintions in the config/lono directory.  Any file in this directory will be automatically loaded. An [example](lib/starter_project/config/lono/api.rb) is in the starter project.\r\n\r\n\r\n## Generate\r\n\r\nYou can generate the CF templates by running:\r\n\r\n<pre>\r\n$ lono generate\r\n$ lono g -c # shortcut\r\n</pre>\r\n\r\nThe lono init command also sets up guard-lono.  Guard-lono continuously generates the cloud formation templates.  Just run guard.\r\n\r\n<pre>\r\n$ guard\r\n</pre>\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}